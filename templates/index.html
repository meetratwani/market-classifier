<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 0;
        }

        .lucide {
            display: inline-block;
            stroke-width: 2;
            vertical-align: middle;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .viz-image {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }

        .viz-description {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.5;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10b981',
                        'primary-red': '#ef4444',
                    }
                }
            }
        }

        const API_BASE = 'http://localhost:5000/api';
        let stockData = [];
        let currentTickers = '';

        function formatCurrency(amount, currency) {
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return `${currency}${formatter.format(amount)}`;
        }

        function createStockCard(stock) {
            const colorClass = stock.isPositive ? 'text-primary-green' : 'text-primary-red';
            const priceColorClass = stock.isPositive ? 'bg-primary-green/10' : 'bg-primary-red/10';
            const directionArrow = stock.arrow || (stock.isPositive ? '↑' : '↓');
            const directionText = stock.direction || (stock.isPositive ? 'UP' : 'DOWN');
            const currency = stock.currency || '$';
            
            const currentPriceFormatted = formatCurrency(stock.currentPrice, currency);
            const estimatedPriceFormatted = stock.estimatedPrice ? formatCurrency(stock.estimatedPrice, currency) : 'N/A';
            const priceChange = stock.estimatedPrice ? ((stock.estimatedPrice - stock.currentPrice) / stock.currentPrice * 100).toFixed(2) : null;
            const peText = stock.peRatio !== null && stock.peRatio !== undefined ? stock.peRatio.toFixed(2) : 'N/A';
            const divYieldText = stock.dividendYield !== null && stock.dividendYield !== undefined ? stock.dividendYield.toFixed(2) + '%' : 'N/A';
            const nextEarningsText = stock.nextEarningsDate ? new Date(stock.nextEarningsDate).toLocaleDateString() : 'N/A';
            const lastEarningsText = stock.lastEarningsDate ? new Date(stock.lastEarningsDate).toLocaleDateString() : null;
            const epsText = stock.eps !== null && stock.eps !== undefined ? stock.eps.toFixed(2) : null;

            return `
                <div class="p-4 border-t border-gray-100 mt-4 first:mt-0 ${stock.hasRealPrediction ? '' : 'opacity-60'}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${stock.ticker}</h3>
                            ${stock.hasRealPrediction ? '<span class="text-xs text-green-600 font-medium">✓ ML Prediction</span>' : '<span class="text-xs text-gray-400">Limited data</span>'}
                        </div>
                        <span class="text-4xl font-bold ${colorClass} py-2 px-4 rounded-full ${priceColorClass} flex items-center justify-center min-w-[80px]">
                            ${directionArrow}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-600 mt-3">
                        <div class="font-medium text-gray-700">Current Price:</div>
                        <div class="text-right font-semibold">${currentPriceFormatted}</div>
                        
                        ${stock.estimatedPrice ? `
                        <div class="font-medium text-gray-700">Estimated Price:</div>
                        <div class="text-right font-bold ${colorClass}">${estimatedPriceFormatted}</div>
                        
                        <div class="font-medium text-gray-700">Expected Change:</div>
                        <div class="text-right font-semibold ${colorClass}">${priceChange > 0 ? '+' : ''}${priceChange}%</div>
                        ` : ''}
                        
                        <div class="font-medium text-gray-700">Direction:</div>
                        <div class="text-right font-bold ${colorClass} text-lg">${directionText} ${directionArrow}</div>
                        
                        <div class="font-medium text-gray-700">Confidence:</div>
                        <div class="text-right font-semibold text-blue-600">${stock.confidence || stock.confidenceLevel || 'N/A'}%</div>
                        
                        ${stock.probabilityUp !== undefined ? `
                        <div class="font-medium text-gray-700">P(UP):</div>
                        <div class="text-right text-green-600">${stock.probabilityUp}%</div>
                        
                        <div class="font-medium text-gray-700">P(DOWN):</div>
                        <div class="text-right text-red-600">${stock.probabilityDown}%</div>
                        ` : ''}

                        ${stock.expectedChangePct !== undefined && stock.expectedChangePct !== null ? `
                        <div class="font-medium text-gray-700">Expected Move:</div>
                        <div class="text-right font-semibold ${colorClass}">${stock.expectedChangePct > 0 ? '+' : ''}${stock.expectedChangePct}%</div>
                        ` : ''}

                        <div class="font-medium text-gray-700">P/E Ratio:</div>
                        <div class="text-right font-semibold">${peText}</div>

                        <div class="font-medium text-gray-700">Dividend Yield:</div>
                        <div class="text-right font-semibold">${divYieldText}</div>

                        <div class="font-medium text-gray-700">Next Earnings:</div>
                        <div class="text-right font-semibold">${nextEarningsText}</div>
                    </div>

                    <div class="mt-5 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Suggested Action</p>
                                <p class="text-lg font-bold text-gray-900">${stock.recommendation || 'N/A'}</p>
                            </div>
                            <span class="text-sm font-semibold text-gray-600">${stock.riskLevel || 'Unknown'} risk</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${stock.rationale || 'Action rationale unavailable.'}</p>
                        <p class="text-xs text-gray-400 mt-1">${stock.riskNote || ''}</p>
                        ${lastEarningsText || epsText ? `
                        <p class="text-xs text-gray-500 mt-2">
                            Recent earnings${lastEarningsText ? ` on <span class="font-semibold">${lastEarningsText}</span>` : ''}${epsText ? `, EPS <span class="font-semibold">${epsText}</span>` : ''}.
                        </p>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderStocks() {
            const container = document.getElementById('stock-predictions-container');
            if (container && stockData.length > 0) {
                container.innerHTML = stockData.map(createStockCard).join('');
            } else if (container) {
                container.innerHTML = '<div class="text-center p-8 text-gray-400">No predictions yet. Search for stocks above.</div>';
            }
        }

        function showLoading() {
            const container = document.getElementById('stock-predictions-container');
            container.innerHTML = `
                <div class="text-center p-8">
                    <div class="loading-spinner mx-auto mb-3"></div>
                    <p class="text-gray-500 text-sm font-semibold">Training ML model on 2 years of data...</p>
                    <p class="text-gray-400 text-xs mt-2">Engineering features • Training XGBoost • Predicting movements</p>
                    <p class="text-gray-400 text-xs mt-1">(This may take 30-60 seconds on first request)</p>
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('stock-predictions-container');
            container.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-red-500 mb-2">
                        <i data-lucide="alert-circle" class="lucide w-12 h-12 mx-auto"></i>
                    </div>
                    <p class="text-gray-600 text-sm">${message}</p>
                </div>
            `;
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
            }
        }

        async function handleSearch() {
            const query = document.getElementById('search-input').value.trim();
            
            if (!query) {
                document.getElementById('search-status').textContent = 'Please enter at least one stock ticker.';
                document.getElementById('search-status').classList.add('text-red-500');
                return;
            }

            currentTickers = query;
            document.getElementById('search-status').textContent = `Running main.py pipeline for "${query}"...`;
            document.getElementById('search-status').classList.remove('text-red-500');
            document.getElementById('search-status').classList.add('text-blue-500');
            
            showLoading();

            try {
                const response = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tickers: query })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch predictions');
                }

                const data = await response.json();
                stockData = data.predictions;
                
                renderStocks();
                
                let statusText = `Loaded ${stockData.length} real ML prediction(s).`;
                if (data.metadata && data.metadata.model_accuracy !== undefined && !isNaN(data.metadata.model_accuracy)) {
                    statusText += ` Model Accuracy: ${(data.metadata.model_accuracy * 100).toFixed(1)}%`;
                    if (data.metadata.note) {
                        statusText += ` (${data.metadata.note})`;
                    }
                }
                
                document.getElementById('search-status').textContent = statusText;
                document.getElementById('search-status').classList.remove('text-blue-500');
                document.getElementById('search-status').classList.add('text-green-500');

                document.getElementById('view-viz-btn').classList.remove('hidden');
                document.getElementById('download-report-btn').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching predictions:', error);
                showError(error.message || 'Failed to load predictions. Please try again.');
                document.getElementById('search-status').textContent = 'Error loading predictions.';
                document.getElementById('search-status').classList.remove('text-blue-500');
                document.getElementById('search-status').classList.add('text-red-500');
            }
        }

        async function showVisualizations() {
            const modal = document.getElementById('viz-modal');
            const modalContent = document.getElementById('viz-content');
            
            modal.classList.add('active');
            modalContent.innerHTML = `
                <div class="text-center p-8">
                    <div class="loading-spinner mx-auto mb-3"></div>
                    <p class="text-gray-500 text-sm">Loading visualizations...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/visualizations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tickers: currentTickers })
                });

                if (!response.ok) {
                    throw new Error('Failed to load visualizations');
                }

                const data = await response.json();
                
                modalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Model Visualizations</h2>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800">
                                <i data-lucide="x" class="lucide w-6 h-6"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-xs text-gray-600 mb-1">Train Accuracy</div>
                                <div class="text-xl font-bold text-blue-600">${(data.metrics.train_accuracy * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-xs text-gray-600 mb-1">Test Accuracy</div>
                                <div class="text-xl font-bold text-green-600">${(data.metrics.test_accuracy * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <div class="text-xs text-gray-600 mb-1">F1-Score</div>
                                <div class="text-xl font-bold text-purple-600">${(data.metrics.test_f1 * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg text-center">
                                <div class="text-xs text-gray-600 mb-1">ROC-AUC</div>
                                <div class="text-xl font-bold text-orange-600">${data.metrics.test_roc_auc.toFixed(3)}</div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Price History (2 Years)</h3>
                                <div class="viz-description">
                                    <strong>What this shows:</strong> Historical closing prices over the past 2 years. This helps understand the stock's price trends, volatility, and overall market behavior during different periods. You can see how the stock has performed over time, identify patterns, and observe any significant price movements or market events.
                                </div>
                                <img src="${data.priceHistory}" class="viz-image border border-gray-200" alt="Price History">
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Confusion Matrix</h3>
                                    <div class="viz-description">
                                        <strong>What this shows:</strong> A breakdown of correct vs incorrect predictions. The diagonal shows correct predictions (true positives/negatives), while off-diagonal shows errors. Higher diagonal values indicate better model performance. This helps you understand where the model makes mistakes and how accurate it is for UP vs DOWN predictions.
                                    </div>
                                    <img src="${data.confusionMatrix}" class="viz-image border border-gray-200" alt="Confusion Matrix">
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ROC Curve</h3>
                                    <div class="viz-description">
                                        <strong>What this shows:</strong> Receiver Operating Characteristic curve measuring the model's ability to distinguish between UP and DOWN movements. A curve closer to the top-left corner indicates better predictive power. The area under the curve (AUC) quantifies overall performance - values closer to 1.0 mean better classification ability.
                                    </div>
                                    <img src="${data.rocCurve}" class="viz-image border border-gray-200" alt="ROC Curve">
                                </div>
                            </div>

                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Feature Importance</h3>
                                <div class="viz-description">
                                    <strong>What this shows:</strong> The top features that most influence the model's predictions. Features like technical indicators (RSI, MACD, moving averages), price patterns, and market regime indicators are ranked by their contribution to the model's decision-making process. This helps you understand which factors the AI considers most important when making predictions.
                                </div>
                                <img src="${data.featureImportance}" class="viz-image border border-gray-200" alt="Feature Importance">
                            </div>

                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Returns Distribution</h3>
                                <div class="viz-description">
                                    <strong>What this shows:</strong> The frequency distribution of daily returns. This reveals the stock's volatility patterns, showing how often different return magnitudes occur. A normal distribution centered around zero suggests typical market behavior, while skewness indicates directional bias. This helps assess the stock's risk profile and return characteristics.
                                </div>
                                <img src="${data.returnsDistribution}" class="viz-image border border-gray-200" alt="Returns Distribution">
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                Close Visualizations
                            </button>
                        </div>
                    </div>
                `;
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Error loading visualizations:', error);
                modalContent.innerHTML = `
                    <div class="p-6 text-center">
                        <div class="text-red-500 mb-3">
                            <i data-lucide="alert-circle" class="lucide w-12 h-12 mx-auto"></i>
                        </div>
                        <p class="text-gray-600 mb-4">Failed to load visualizations</p>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                `;
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            }
        }

        function closeModal() {
            document.getElementById('viz-modal').classList.remove('active');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        }

        async function downloadReport() {
            if (!currentTickers) {
                document.getElementById('search-status').textContent = 'Run a prediction before exporting.';
                document.getElementById('search-status').classList.add('text-red-500');
                return;
            }
            const button = document.getElementById('download-report-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner mr-2"></span>Preparing ZIP...';
            try {
                const response = await fetch(`${API_BASE}/download-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tickers: currentTickers })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to prepare report');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `market-report-${new Date().toISOString().replace(/[:.]/g, '-')}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                document.getElementById('search-status').textContent = 'Report downloaded successfully.';
                document.getElementById('search-status').classList.add('text-green-500');
            } catch (error) {
                console.error('Download error:', error);
                document.getElementById('search-status').textContent = error.message || 'Failed to download report.';
                document.getElementById('search-status').classList.add('text-red-500');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        window.onload = () => {
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
            }
            document.getElementById('search-input').value = "AAPL, TSLA, GOOGL";
            document.getElementById('search-input').addEventListener('keypress', handleKeyPress);
            
            window.onclick = function(event) {
                const modal = document.getElementById('viz-modal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        };

    </script>
</head>
<body>

    <div class="w-full max-w-sm md:max-w-md bg-white rounded-xl shadow-2xl overflow-hidden ring-1 ring-gray-200">

        <header class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h1 class="text-lg font-bold text-gray-800">Market Movement Classifier</h1>
            <div class="flex items-center space-x-3">
                <span class="text-sm font-semibold text-gray-600">Aimers Predictor</span>
                <button class="text-gray-500 hover:text-gray-800 transition duration-150">
                    <i data-lucide="share-2" class="lucide w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="p-4">
            <p class="text-sm text-gray-500 mb-3">Search for stocks and get AI-powered predictions using main.py pipeline</p>
            <div class="relative">
                <i data-lucide="search" class="lucide w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input 
                    id="search-input"
                    type="text" 
                    placeholder="Search for stocks (e.g., AAPL, TSLA, GOOGL)" 
                    class="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm text-gray-700"
                    value=""
                />
                <button onclick="handleSearch()" class="absolute right-0 top-0 h-full px-3 text-blue-600 hover:text-blue-800 transition duration-150 font-medium text-sm">
                    Search
                </button>
            </div>
            <p id="search-status" class="text-xs text-gray-500 mt-2 h-4 transition-all duration-300"></p>
        </div>

        <div id="stock-predictions-container" class="pb-3">
            <div class="text-center p-8 text-gray-400">Search for stocks to see predictions...</div>
        </div>

        <div class="px-4 pb-4 space-y-2">
            <button id="view-viz-btn" onclick="showVisualizations()" class="hidden w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg hover:from-blue-600 hover:to-purple-700 transition font-semibold flex items-center justify-center space-x-2">
                <i data-lucide="bar-chart-3" class="lucide w-5 h-5"></i>
                <span>View Model Visualizations</span>
            </button>
            <button id="download-report-btn" onclick="downloadReport()" class="hidden w-full bg-white border border-blue-500 text-blue-600 py-3 rounded-lg hover:bg-blue-50 transition font-semibold flex items-center justify-center space-x-2">
                <i data-lucide="download" class="lucide w-5 h-5"></i>
                <span>Download CSV + Visuals</span>
            </button>
        </div>
        
        <footer class="p-4 border-t border-gray-100 bg-gray-50 text-center text-xs text-gray-500 font-medium">
            <i data-lucide="zap" class="lucide w-4 h-4 inline mr-1 text-blue-500"></i>
            Powered by Meet and Jaimin • Using main.py ML Pipeline
        </footer>
    </div>

    <div id="viz-modal" class="modal">
        <div class="modal-content" id="viz-content">
        </div>
    </div>

</body>
</html>